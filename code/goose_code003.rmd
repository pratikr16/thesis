---
title: Goose Flock Data Description 02
output: 
  tufte::tufte_handout
---

```{r, include=FALSE}
#'load knitr
library(knitr)

#'suppress all code output but run code
opts_chunk$set(echo = FALSE)
opts_knit$set(root.dir = "~/git/thesis/")
```

```{r load data, include=FALSE}
#'load libs
library(readxl)
library(RColorBrewer)

#'create color pal
goose_cols = colorRampPalette(brewer.pal(9, "YlOrRd"))

#'import data
lt_geese = read_excel("~/git/thesis/Age-ratiodata-GWfG-toPratik.xlsx", 
    sheet = "Plain_table", col_types = c("text", 
        "numeric", "numeric", "numeric", 
        "numeric", "text", "text", "text", 
        "text", "numeric", "text", "text", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "text", 
        "text"))
```

```{r get family sites, include=FALSE}
#'all records in the netherlands or nrw after than 2000

#'first keep only nl or nrw after 2000
study_site = lt_geese[lt_geese$Country == "NL"|lt_geese$Country=="NRW",]

study_site = study_site[study_site$Breeding_year > 2000,]

unique(study_site$Country)

#'then sum family data
study_site = cbind(study_site, fams = apply(study_site[,c(19:28)], 1, function(x){sum(x, na.rm = T)}))
```

# Flock size and mixed flocking

1. From the first data description, we know that the majority of records are from the Netherlands and North Rhine Westphalia.

2. It may be useful to explore how flock size varies with province and month, and then repeat the same for juvenile proportion.

3. First, I fixed an issue with the total flock size. It appears that in some cases, total flock size is left blank. It may be safe to assume that this was done when the total flock size was later computed by adding the number of juveniles and adults. In this case, it was not a mixed flock, and only whitefronts were present.

```{r total_flock, include=FALSE}
#'set total flock size
study_site$Total_flock = ifelse(is.na(study_site$Total_flock),
                        study_site$N_Adult + study_site$N_Juvenile,
                        study_site$Total_flock)

#'how many NAs now?
sum(is.na(study_site$Total_flock))

#'NAs in month and year
dim(study_site[is.na(study_site$Year) | is.na(study_site$Month),])

#'any pattern?
summary(study_site[is.na(study_site$Year) | is.na(study_site$Month),])
```

4. After fixing the issue of missing total flock sizes, ```r sum(is.na(study_site$Total_flock))``` ```NA```s remain. These may be safely ignored. Additionally, ```r dim(study_site[is.na(study_site$Year) | is.na(study_site$Month),])[1]``` record(s) from the study site has no year or month data. This is also removed.
```{r remove_monthna}
study_site = study_site[!is.na(study_site$Month),]

```


5. From an ecological perspective, it may be interesting to know something about mixed flocking. Such flocks would be those in which the total flock size is greater than the number of whitefronts sampled. ```r sum(study_site$Total_flock > study_site$N_sampled, na.rm = T)``` such flocks were found, which is around half of all flocks.

```{r mixed_flocks, include=FALSE}
sum(study_site$Total_flock > study_site$N_sampled, na.rm = T)

```


6. I then checked the distribution of the proportion of whitefronts in flocks. Apart from the nearly 3000 flocks in which only whitefronts were present, they also formed flocks in the full range of proportions with other geese. This was not changed with month.

```{r whitefronts_prop, warning=FALSE, fig.cap= "Whitefront proportion in mixed flocks over winter months.", fig.height=4, fig.width=10}
#'plot histogram of whitefront proportion
library(ggplot2)
ggplot()+
  geom_histogram(data = study_site[(study_site$Month %in%
                                      c(1:3,10:12)),],
    aes(x = N_sampled/Total_flock), 
                     #fill = as.factor(Month)),
                 bins = 30)+
 # scale_fill_brewer(palette = "RdGy")+
  facet_wrap(~Month)+
  xlim(0,1.02)+
  labs(list(x = "Whitefront proportion in flocks",
            fill = "Month", title="Whitefront proportion ~ winter months"))+
  theme_bw()
```

# Flock size change over winter

7. I then looked at flock size distributions over the winter months. This followed the form of a power law decay function, with many small flocks but also a number of large flocks. The number of flocks recorded in the late winter was lower as expected.

```{r data_dist, echo=FALSE, fig.cap="Total flock size in winter months.", message=FALSE, warning=FALSE, fig.height=4, fig.width=10}
#'use ggplot histograms
library(ggplot2)

ggplot()+
  geom_histogram(data = study_site[(study_site$Month %in%
                                      c(1:3,10:12)),], 
aes(x = Total_flock, fill = as.factor(Month), binwidth = 200),
col = "grey40",lwd=0.1)+
  scale_fill_brewer(palette = "Greys")+
  facet_wrap(~Month)+
  labs(list(x = "Month", fill ="Month",
            title="Flock size ~ winter months"))+
  xlim(0,5000)+
  theme_bw()
```

```{r juvprop_month, fig.cap="Juvenile percentage in wintering flocks in each winter month.", fig.height=4, fig.width=10, message=FALSE, warning=FALSE}
#'plot
ggplot()+
  geom_histogram(data = study_site[study_site$Month %in% c(1:3,10:12),], 
    aes(x = `Perc-JV`, na.rm = T,
    fill = as.factor(Month)), col = "grey40",lwd=0.1)+
  scale_fill_brewer(palette = "Greys")+
  facet_wrap(~Month)+
  labs(list(x = "Juvenile percentage", fill = "Month",
            title="Juvenile percentage ~ winter months"))+
  theme_bw()
```

# Time as a continuous variable

The data were assigned a continuous time variable as a ```POSIXct``` object from the separate day, month and year columns.

```{r timeseries, include=FALSE}
#'convert three columns to posixct
#'first convert year month date to char

study_site$time = as.POSIXct(paste(study_site$Year, study_site$Month, study_site$Day), format="%Y %m %d")

#'melt data
goose_time = study_site[,c("Region","Breeding_year","Total_flock","Perc-JV","fams","time")]
goose_time = goose_time[goose_time$time < "2012-05-01",]

goose_time = goose_time[complete.cases(goose_time),]

library(plyr);library(reshape)
#goose_time = melt(goose_time, id.vars = c("Region","Breeding_year"))

library(lubridate)
```

After removing all records where time data was incomplete, ```r dim(goose_time)[1]``` records remained.

# Records per region over time

I then checked to see how the flocksize varied over time from each region. Some regions are very sparsely sampled.

```{r records_region_time, fig.height=7, fig.width=10, fig.cap= "Flock size over time, separated by region."}
#'basic plots
ggplot()+
  geom_point(data = goose_time, 
             aes(x = time, y = Total_flock), size = 0.5)+
  facet_wrap(~Region ,scales = "fixed")+
  #ylim(0,5000)+
  theme_bw()
```


# Flock size - juvenile percentage pairs

8. I then looked for counts of flocksize - juvenile percentage pairs, using hexbins. I restricted the maximum flock size considered to 5000, since flocks larger than that were not common. Flocks with a size less than 500 and a juvenile proportion less that 0.3 are most common overall.

```{r hex_jvprop_flock, fig.cap="Hexbins showing counts of combinations of flocksize and juvenile proportion.", fig.height=5, fig.width=6}
#'hexbin juvprop flock size
ggplot()+
 geom_hex(data = study_site, aes(x =Total_flock, 
              y = `Perc-JV`), bins = 30, na.rm = T)+
  scale_fill_gradientn(colours= rev(brewer.pal(11, "Spectral")))+
  labs(list(x = "Flocksize",
            y="Juvenile percentage",
            title = "Hexbins, flocksize ~ juvenile percentage"))+
 xlim(0,5000)+
  theme_bw()
```

9. I then separated this data by month. Visually, an increase in any particular pair of flocksize and juvenile proportion would be represented by shift in the colour scale towards yellow-red, representing the counts of such a pair. In the hexbin plot representing month wise juvenile proportions, one could expect the yellow-red, ie, more frequent, hexbins, to shift higher up the Y-axis, since previous observations have estimated an increasing trend in the juvenile proportion through the winter. Such a trend is not seen in the hexbin plot. Overall, variability in the counts of flocks with different adult juvenile compositions is reduced through the winter.

```{r hex_jvprop_flock_month, fig.cap="Hexbins showing counts of combinations of flocksize and juvenile proportion.", fig.height=5, fig.width=7}
#'hexbin juvprop flock size
ggplot()+
 geom_hex(data = study_site[study_site$Month %in% c(1:3,10:12),], aes(x =Total_flock, 
              y = `Perc-JV`), bins = 30, na.rm = T)+
  scale_fill_gradientn(colours= rev(brewer.pal(11, "Spectral")))+
  labs(list(x = "Flocksize",
            y="Juvenile percentage",
            title = "Hexbins, flocksize ~ juvenile percentage, per month"))+
  facet_wrap(~Month)+
 xlim(0,5000)+
  theme_bw()
```

10. I then separated the data into data from five representative provinces as follows: Wesel (south east, inland), Zeeland (south west, coastal), Friesland (north west, coastal), and South Holland (centre, coastal).
No clear trend was seen in the hexbin representation of data. Records from Wesel and Friesland produced a hexbin plot most similar to the pooled data. Zeeland shows the most irregular pattern, with higher flock sizes.

```{r hex_jvprop_flock_rg, fig.cap="Hexbins showing counts of combinations of flocksize and juvenile proportion.", fig.height=5, fig.width=7}
#'hexbin juvprop flock size
ggplot()+
 geom_hex(data = study_site[study_site$Region %in% c("WES","ZL","FR","ZH"),], 
          aes(x =Total_flock, 
              y = `Perc-JV`), bins = 30, na.rm = T)+
  scale_fill_gradientn(colours= rev(brewer.pal(11, "Spectral")))+
  labs(list(x = "Flocksize",
            y="Juvenile percentage",
            title = "Hexbins, flocksize ~ juvenile percentage, major regions"))+
  facet_wrap(~Region)+
 xlim(0,5000)+
  theme_bw()
```

---

```{r, fig.cap="Flock size in some regions in each month. No clear pattern is seen.", fig.height=7, fig.width=10, include=FALSE}
#'boxplot flocksize region
ggplot()+
  geom_boxplot(data = study_site[study_site$Region %in% c("WES","ZL","FR","ZH"),], 
               aes(x = as.factor(Month), 
                                    y = Total_flock))+
  facet_wrap(~Region, ncol=1)+
  labs(list(x = "Month",y = "Flock size"))+
  ylim(0,2000)+
  theme_bw()
```

```{r, fig.cap="Juvenile percentage in some regions in each month. No clear pattern is seen.", fig.height=7, fig.width=10, include=FALSE}
#'boxplot flocksize region
ggplot()+
  geom_boxplot(data = study_site[study_site$Region %in% c("WES","ZL","FR","ZH"),], 
               aes(x = as.factor(Month), 
                                    y = `Perc-JV`))+
  facet_wrap(~Region, ncol=1)+
  labs(list(x = "Month",y = "Flock size"))+
  theme_bw()
```
