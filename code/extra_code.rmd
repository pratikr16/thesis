```{r juvprop_month, fig.cap="Juvenile percentage in wintering flocks in each winter month. Scales are free.", fig.height=7, fig.width=10, message=FALSE, warning=FALSE}
#'plot
ggplot()+
  geom_histogram(data = study_site[study_site$Month %in% c(1:3,10:12),], 
                 aes(x = `Perc-JV`, na.rm = T,
                     fill = as.factor(Month)))+
  scale_fill_brewer(palette = "Oranges")+
  facet_wrap(~Month, scales = "free")+
  labs(list(x = "Juvenile percentage", fill = "Month",
            title="Juvenile percentage ~ winter months"))+
  theme_bw()
```

# Juvenile percentage, region and month

9. The final step was to visualise whether there was any interaction between the juvenile percentage, the month, and the region. With 22 regions, I restricted the visualisation to geographically representative ones: Wesel (south east), Zeeland (south west), Friesland (north west), Leer (north east), and Gelderland (centre).

```{r max_regions, include=FALSE}
sort(table(as.factor(study_site$Region)))


```

```{r juvprop_region_month2, fig.height=7, fig.width=10, warning=FALSE, message=FALSE, fig.cap="Juvenile proportion in early winter months, in five provinces.", fig.fullwidth=T}
#plot juv prop vs region in months
ggplot()+
  geom_histogram(data = study_site[study_site$Region %in% c("WES","ZL","FR","LER","GL") & study_site$Month %in% c(10,11,12),], 
                 aes(x = `Perc-JV`, na.rm=T,
                     fill = as.factor(Month)),binwidth = 5, stat = "bin")+
  scale_fill_brewer(palette = "Blues")+
  facet_wrap(~Month*Region, scales = "fixed", ncol = 5, drop = F)+
  labs(list(x = "Juvenile percentage", fill = "Month",
            title="Juvenile percentage ~ early winter months"))+
  theme_bw()
```


```{r juvprop_region_month, fig.height=7, fig.width=10, warning=FALSE, message=FALSE, fig.fullwidth=T, fig.cap="Juvenile proportion in late winter months, in five provinces."}
#plot juv prop vs region in months
ggplot()+
  geom_histogram(data = study_site[study_site$Region %in% c("WES","ZL","FR","LER","GL") & study_site$Month %in% c(1,2,3),], 
                 aes(x = `Perc-JV`, na.rm=T,
                     fill = as.factor(Month)),binwidth = 5, stat = "bin")+
  scale_fill_brewer(palette = "Oranges")+
  facet_wrap(~Month*Region, scales = "fixed", ncol = 5, drop = F)+
  labs(list(x = "Juvenile percentage", fill = "Month",
            title="Juvenile percentage ~ late winter months"))+
  theme_bw()
```

```{r, hex_jvrprop_flocksize_month_early, fig.height=7, fig.width=10, warning=FALSE, message=FALSE, fig.fullwidth=T}
ggplot()+
 geom_hex(data = study_site[study_site$Region %in% c("WES","ZL","FR","LER","GL") & study_site$Month %in% c(10,11,12),], 
          aes(x =Total_flock, 
              y = `Perc-JV`), bins = 15, na.rm = T)+
  scale_fill_gradientn(colours= rev(brewer.pal(11, "Spectral")))+
  labs(list(x = "Flocksize",
            y="Juvenile percentage",
            title = "Hexbins, flocksize ~ juvenile percentage, early winter"))+
  facet_wrap(~Month*Region, scales = "fixed", ncol = 5, drop = F)+
xlim(0,5000)+
  theme_bw()
```

```{r, hex_jvrprop_flocksize_month_late, fig.height=7, fig.width=10, warning=FALSE, message=FALSE, fig.fullwidth=T}
ggplot()+
 geom_hex(data = study_site[study_site$Region %in% c("WES","ZL","FR","LER","GL") & study_site$Month %in% c(1,2,3),], 
          aes(x =Total_flock, 
              y = `Perc-JV`), bins = 15, na.rm = T)+
  scale_fill_gradientn(colours= rev(brewer.pal(11, "Spectral")))+
  labs(list(x = "Flocksize",
            y="Juvenile percentage",
            title = "Hexbins, flocksize ~ juvenile percentage, late winter"))+
  facet_wrap(~Month*Region, scales = "fixed", ncol = 5, drop = F)+
 # xlim(0,2000)+
  theme_bw()
```

```{r plot_a_time_series}
#'plot ts
ggplot(data = melt(fortify(goose_aggregate)[,c(1,3,4)], id.vars = "Index"))+
  geom_line(aes(x = Index, y = value, 
                col = ifelse(month(Index)%in%c(1:3,10:12), "black",
                         "red")), lwd = 0.2)+
  scale_colour_manual(values = c("black",NA))+
  facet_wrap(~variable, ncol = 1, scales = "free")+
  guides(colour = F)+
  theme_bw()
```

# Convert to ```timeseries```

```{r goose_timeseries_global}
#'for flocksize
#'start the time series at 2001.75, as in october 2001, 3/4 of the
#'year is done
goose_ts = ts(goose_time_merge[,c("Total_flock","Perc.JV")], start = c(2001.75,1),
              frequency = 365)

#'plot to check
plot(goose_ts, 
     main = "Flock size and juvenile proportion over time",
     font.main = 3)
```

```{r seasonal_decomp_using_stlplus}
#'run the first field, flock size, through stlplus
#'loadlibs
library(stlplus)

#'stl flocksize
stl_flock_size = stlplus(goose_ts[,1], s.window = "periodic")
```

```{r plot_flocksize_stl}
plot(stl_flock_size)
```

```{r get_juvprop_stl}
#'stl on juvprop
stl_juvprop = stlplus(goose_ts[,2], s.window = "periodic")
```

```{r plot_juvprop_stl}
#'plot it
plot(stl_juvprop)
```

```{r save_trends_together}
#'get trend
trend_juvprop = trend(stl_juvprop)

#'plot trend as before
trend_plot_02 = ggplot()+
  geom_path(aes(y = trend_juvprop, x = z),
            col = ifelse(is.na(goose_ts[,2]),
                         "magenta","blue"),
            size = 1)+
  labs(list(x = "Time",y = "Juvenile proportion trend"))+
  theme_minimal()

#'get_flock_trend and plot
flock_trend = trend(stl_flock_size)

#get seq
z = seq(2001.75, 2012.25, length.out = dim(goose_ts)[1])

#'plot trend
trend_plot_01 = ggplot()+
  geom_line(aes(y = flock_trend, x = z),
            col = ifelse(is.na(goose_ts[,1]),
                         "magenta","blue"),
            size = 1)+
  labs(list(x = "Time",y = "Flock size trend"))+
  theme_minimal()
```

```{r plot_trends}
#'load gridextra
library(gridExtra)

#'plot using gridarrange
grid.arrange(trend_plot_01, trend_plot_02)

```

```{r ts_by_zone}
#'convert zone to factor
goose_time_merge$zone = as.factor(goose_time_merge$zone)

#'make a list and separate the data as items in it
data_by_zone = list()
for(i in 1:4){
 data_by_zone[[i]] = goose_time_merge[goose_time_merge$zone ==                                  unique(goose_time_merge$zone)[i],]
}

#'along the list, now merge each df with day_seq
data_by_zone = lapply(data_by_zone,
                    function(x){merge(data.frame(day_seq), 
                     x, by = "day_seq", all.x = T)})

#'now make another list with ts objects
ts_by_zone = lapply(data_by_zone, function(x){
  ts(x[,c("Total_flock","Perc.JV")], start = c(2001.75,1),
              frequency = 180)
})

#plot to check
par(mfrow = c(2,2))
for(i in 1:4){
  plot(ts_by_zone[[i]][,1],
       main = paste(unique(na.omit(data_by_zone[[i]])$zone)),
       ylab = "Flock size")
}

for(i in 1:4){
  plot(ts_by_zone[[i]][,2],
       main = paste(unique(na.omit(data_by_zone[[i]])$zone)),
       ylab = "Juvenile %")
}
```

```{r stl_by_zone}
#'set all NAs to 0 since stlplus doesn't work on the ts as they are

for(i in 1:4){
 ts_by_zone[[i]][is.na(ts_by_zone[[i]])] = 0
}

#'apply stlplus over the ts list
#'for flock size
stl_flock_zone = lapply(ts_by_zone,
                        function(x){
                          stlplus(x[,1], s.window = "periodic")
                        })

#'for juvprop
stl_juv_zone = lapply(ts_by_zone,
                        function(x){
                          stlplus(x[,2], s.window = "periodic")
                        })
```

```{r plot_zonal_stls}
#'flocksize

par(mfrow = c(2,2))
for(i in 1:4){
  plot(trend(stl_flock_zone[[i]]),
       main = paste(unique(na.omit(stl_flock_zone[[i]])$zone)),
       type = "l", lwd = 2)
}
```


## Family size ~ zone
```{r mean_fam_size_zone_year}
#'how does mean fam size vary over zone?
#'first get mean of means in all zones in all years
mean_fam_table = ddply(fams, c("zone", "Breeding_year"), summarise, meanfam = mean(Mean_Fam))

#'convert zone and year to factors
mean_fam_table$zone = as.factor(mean_fam_table$zone)
mean_fam_table$Breeding_year = as.factor(mean_fam_table$Breeding_year)

#'convert to wide format, not necessary but useful
mean_fam_table2 = cast(mean_fam_table, formula = zone~Breeding_year,
                      value = "meanfam")

#'run aov
meanfam_aov = aov(Mean_Fam ~ zone, data = fams)

summary(meanfam_aov)
#'breeding year is significant, zone is not. there goes the families are larger in the west idea...

#'visualise and run a posthoc
plot(TukeyHSD(meanfam_aov))
```

```{r load_clean_data, include=FALSE}
#'load data
goose_clean = read.csv("data.clean.goose.csv")

#assign zones
goose_clean$zone = ifelse(goose_clean$Region %in% c("DU","KLE","RG","WES","WG"),
       "Rhinelands",
       ifelse(goose_clean$Region %in% c("LER","DR","GR"),
              "East Frisia",
       ifelse(goose_clean$Region %in% c("FR","FL","NH"),
              "IJsselmeer",
              ifelse(goose_clean$Region %in% c("ZL","ZH"),
                     "Southwest", "Other"))))
```

```{r create_limited_df, include=FALSE}
#'create limited data frame
goose_time = goose_clean[,c("Region","Breeding_year","Total_flock","Perc.JV","time")]

#'set time as posixct
goose_time$time = as.Date(goose_time$time)

#'where are the NAs?
summary(goose_time[is.na(goose_time$Region),])

#'complete cases for time
goose_time = goose_time[complete.cases(goose_time),]

#'where are the NAs?
apply(goose_time, 2, function(x){sum(is.na(x))})
```

```{r assign_new_zones_ts}
#'assign new zones
goose_time$zone = ifelse(goose_time$Region %in% c("DU","KLE","RG","WES","WG","LI"),
       "Rhinelands",
       ifelse(goose_time$Region %in% c("LER","DR","GR"),
              "East Frisia",
       ifelse(goose_time$Region %in% c("FR","FL","NH"),
              "IJsselmeer", 
              ifelse(goose_time$Region %in% c("ZL","ZH"),
                     "Southwest", "Other"))))
```
```{r create_aggregate, warning=FALSE, include=FALSE}
#'create a df aggregated as means with time as the factor
goose_aggregate = aggregate(goose_time,
                     list(goose_time$time, goose_time$Region),
                     mean)

#'subset to remove factor date and region
goose_aggregate = goose_aggregate[,c("Group.2","Breeding_year",
                                     "Total_flock","Perc.JV",
                                     "time")]

```

```{r creating_regularity, include=FALSE}
#'create a daily sequence from the min to the max date
day_seq = seq(as.Date(min(goose_time$time)),
              as.Date(max(goose_time$time)), by = "day")

#should be more than 3600 days, since this is 10 years
length(day_seq)

#'now reduce to only y-m-d if not already so

#day_seq = as.POSIXct(day_seq, format = "%Y-%m-%d")
#'now merge goose_aggregate df with time seq

#'convert goose_aggregate$time to Date
#'oh dear, never thought i'd use as.Date!
goose_aggregate$time = as.Date(goose_aggregate$time)

#'merge the day sequence and the aggregated goose data
#'take care to keep empty places where there are no observations
goose_time_merge = merge(as.data.frame(day_seq),
                         goose_aggregate, by.x = "day_seq",
                         by.y = "time", all.x = T)

#'how many complete cases? same as the number of aggregated records
sum(complete.cases(goose_time_merge))

#'set all values where no records were taken to 0
#'not very realistic in the winter
#goose_time_merge[is.na(goose_time_merge)] = 0

```

```{r assign_breeding_year, include=FALSE}
#'the breeding year is assigned based on the month of the day sequence. months 1:7 are assigned to the previous breeding year.
library(lubridate)
goose_time_merge$Breeding_year = ifelse(month(goose_time_merge$day_seq) %in% c(1:7),
       year(goose_time_merge$day_seq)-1,
       year(goose_time_merge$day_seq))
```

```{r assign_zones_goose_time, include=FALSE}
#'use the same proc as before
goose_time_merge$zone = ifelse(goose_time_merge$Group.2 %in% c("DU","KLE","RG","WES","WG"),
       "Rhinelands",
       ifelse(goose_time_merge$Group.2 %in% c("LER","DR","GR"),
              "East Frisia",
       ifelse(goose_time_merge$Group.2 %in% c("FR","FL","NH"),
              "IJsselmeer", 
              ifelse(goose_time_merge$Group.2 %in% c("ZL","ZH"),
                     "Southwest", "Other"))))

```


```{r pred_resp_glm_propjuv_bryear01}
#'get the predicted responses as means for each year
geese$glm_pj_bryrresp = predict(glm_propjuv_bryear01, newdata = geese, type = "response")

#'find the mean props in each year
plot(ddply(geese, "Breeding_year", summarise, mean(glm_pj_bryrresp)), 
     type = "p", ylab = "Juvenile proportion", 
     main = "GLM predicted mean juvenile proportion ~ breeding year")
```

```{r post_hoc_glm_propjuv_bryear01}
#'run an aov and a tukey posthoc on that
glm_propjuv_bryear02_phoc = TukeyHSD(aov(glm_propjuv_bryear01))

#'plot to visualise
plot(glm_propjuv_bryear02_phoc, las = 1,
     cex.axis = 0.6, 
     col = ifelse(glm_propjuv_bryear02_phoc[[1]][,4] < 0.05,
                  2, 1))

#'represent as a table
m = matrix(NA, 11,11)
m[lower.tri(m)] = round(glm_propjuv_bryear01_phoc[[1]][,4],4)
m= t(m)
rownames(m) = colnames(m) = as.character(seq(2001,2011,1))
```

```{r glm_propjuv_time01}
#'run the model
glm_propjuv_time01 = glm(propjuv ~ time, data = geese, family = "quasibinomial", na.action = na.omit)

#'summarise the model
summary(glm_propjuv_time01)

plot(glm_propjuv_time01)
```

The model has an AIC score of ```r glm_propjuv_time01$aic```, and an R^2 of ```r 1 - glm_propjuv_time01$deviance/glm_propjuv_time01$null.deviance```.

# Juvenile proportion with categorical times

```{r glm_propjuv_cattime}
library(lubridate)
#'run a glm with the same variables as before, but with the breeding year as a response

#'first make breeding year a factor
geese$Breeding_year = as.factor(geese$Breeding_year)

#'run the model
glm_propjuv_cattime01 = glm(propjuv ~ Breeding_year+as.factor(month(time)),
                           data = geese,
                           family = "quasibinomial")
#'month and year as interacting vars
glm_propjuv_cattime02 = glm(propjuv ~ Breeding_year*as.factor(month(time)),
                           data = geese,
                           family = "quasibinomial")

#'summary of model01 and 02
summary(glm_propjuv_cattime02)

#'compare the models
anova(glm_propjuv_cattime02, glm_propjuv_cattime01, test = "F")

#'check if all terms are necessary in model2
anova(glm_propjuv_cattime02, test = "F")
```

The R-squared value has improved and an F test shows that both the interaction and the month term add to the model. There's still a lot of variation unexplained though.

# Juvenile proportion ~ time * zone

```{r glm_time_zone}
#'run as before, both year and zone are factors
glm_time_zone = glm(propjuv ~ time*zone, 
                    data = geese,
                    family = "quasibinomial")

#'plot it
plot(glm_time_zone)

#'summary
summary(glm_time_zone)

#'compare time*zone and time
anova(glm_propjuv_time01, glm_time_zone, test = "F")
```

```{r glm_cattime_zone}
#'assign a month variable
geese$month = as.factor(month(geese$time))
#'year and zone
glm_cattime_zone = glm(propjuv ~ Breeding_year*month*zone, 
                       data = geese[geese$zone != "Other",], 
                       family = "quasibinomial", na.action = na.omit)

#'plot it
plot(glm_cattime_zone)

#'summary
summary(glm_cattime_zone)

#check if all terms are contributing
anova(glm_cattime_zone, test = "F")
```

# glms
```{r import_data}
#'load geese, fams and fams expanded
geese = read.csv("data.goose.clean.csv", row.names = 1)
fams = read.csv("fams.csv", row.names = 1)
fams.expand = read.csv("fams.expand.csv")

#'convery perc to prop
geese$propjuv = round(geese$propjuv/100, 4)

#'drop zone Other
geese = geese[geese$zone != "Other",]

#'juvenile proportion is actually N_juv/N_sampled
#plot(geese$propjuv2 ~ geese$propjuv,
  #   main = "Calculated vs provided juv prop.",
  #   xlab = "Provided in data",
  #   ylab = "Calculated as N_juvs/No. of whitefronts")

#'change class of time variable to Date
geese$time = as.Date(geese$time)
fams$time = as.Date(fams$time)
fams.expand$time = as.Date(fams.expand$time)

#'add month and day
geese$month = month(geese$time)
geese$day = day(geese$time)
```

# Dataset
The dataset used is the cleaned goose data ```data.goose.clean.csv```. This data has observations between 2001 and 2012, or the breeding years 2011 and 2011. It is restricted to the Netherlands and North Rhine Westphalia, except where it includes areas in East Frisia. Records are classfied into zones. Here, all zones are being used.

# What is the effect of time?

## Predictor: time

### GLMM

```{r glmm_time, eval=FALSE, include=FALSE}
#'model uses time as a Date class object
glmm_time01 = glmer(propjuv ~ time+
                  (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial",
                   na.action = na.omit)

summary(glmm_time02)
#'time is a significant factor, random effects don't explain sufficient variance to justify inclusion.
```

### GLM

```{r glm_time}
glm_time01 = glm(propjuv ~ time,
                  data = geese, family = "binomial",
                   na.action = na.omit)

#'summary
summary(glm_time01)

#'plots
plot(glm_time01)
```


## Predictors: Breeding year * month

### GLMM

```{r glmm_bryr_month01}
glmm_time02 = glmer(propjuv ~ Breeding_year*month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial",
                   na.action = na.omit)

car::Anova(glmm_time02)
#'breeding year and month have significant effects, year*month interaction is not significant, random effects don't explain sufficient variance to be included.
```

### GLM

```{r glm_bryr_month}
#'glm using interaction of year and month
glm_time02a = glm(propjuv ~ Breeding_year*month,
                 data = geese, family = "binomial")

glm_time02b = glm(propjuv ~ Breeding_year*month,
                 data = geese, family = "quasibinomial")

#'summary
summary(glm_time02a); summary(glm_time02b)

#'using a quasibinomial error distribution, breeding year shows a significant effect, but the model doesn't explain any more of the variance than before.
```


## Predictors: Breeding year + month

### GLMM

```{r glmm_bryr_month02}
glmm_time03 = glmer(propjuv ~ Breeding_year+month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial",
                   na.action = na.omit)
summary(glmm_time03)

#'compare model 02 and 03
anova(glmm_time02, glmm_time03)

#'model 03 has a slightly lower AIC score (probably due to one fewer DF), and is not significantly different from model 02. no further attempts are made at modelling month and year as being interacting variables. there is no justification for including random effects since they don't contribute to the variance
```

### GLM

```{r glm_bryr_month}
#'this model ignores random effects and uses month and year as additive effects
glm_time03 = glm(propjuv ~ Breeding_year+month,
                     data = geese, family = "binomial",
                   na.action = na.omit)

#'summary
summary(glm_time03)

#'plot
plot(glm_time03)
```


# What is the effect of zone?

## Predictors: zone * (breeding year + month)

### GLMM

```{r glmm_zone}
glmm_zone01 = glmer(propjuv ~ zone*Breeding_year+ zone* month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial")
summary(glmm_zone01)
#'there don't appear to be any significant differences between zones.

Anova(glmm_zone01)
#'only month and breeding year show significant effects, zone doesn't appear to have an effect. the interaction between zone and year or month does not have an effect. random effects don't explain enough of the variance to justify inclusion
```

### GLM

```{r glm_zone}
#'a glm for the same predictors as above.
glm_zone01 = glm(propjuv ~ zone*Breeding_year+ zone* month,
                   data = geese, family = "binomial")

#'summary
summary(glm_zone01)

#'Anova
car::Anova(glm_zone01)
```


```{r model_lonlat_zone}
#'try with longitude and latitude
sites.coords = read.csv("coords.csv", row.names = 1)

#'merge with geese
geese = merge(geese, sites.coords, by.x = "Site_name", by.y = "places", all.x = T)

#'assign zonal coords if site coords missing
geese$lon.y = ifelse(is.na(geese$lon.y), geese$lon.x, geese$lon.y)
geese$lat.y = ifelse(is.na(geese$lat.y), geese$lat.x, geese$lat.y)

#'run the model with coords lon.x
#mod_lonlat = glmer(propjuv ~ lon.x*lat.x*(Breeding_year+month) +
 #                    (1|Food_type) + (1|Observer) + (1|flocksize),
  #                 data = geese, family = "binomial")

#'a model with lon.x * lat.x * Breeding_year * month fails with errors that the variables are on very different scales. takin the log of the breeding year doesn't resolve the issue.
```


```{r model_lonlat_additive}
#'a very similar model uses the zone coordinates as additive effects along with the breeding year and month
mod_lonlat_add = glmer(propjuv ~ lon.x + lat.x + Breeding_year + month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial")
#'summary
summary(mod_lonlat_add)
#'the summary shows that random effects are not justifiably retained.

glm_lonlat_add = glm(propjuv ~ lon.x + lat.x + Breeding_year + month,
                     data = geese, family = "binomial")

summary(glm_lonlat_add)
plot(glm_lonlat_add)
```

```{r model_latitude}
#'the next model should try using lat.x as a predictor, which might help determine in which direction the gradient if any lies.
mod_zone04 = glmer(propjuv ~ lat.x*log(Breeding_year)+ lat.x*month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial")
#'lat.x approaches significance, with a p-value of 0.08, but doesn't appear sufficient to reject the null.
```

```{r model_coords_fixed}
#'the next model uses both zone latitude and longitude as fixed effects.
mod_zone_05 = glmer(propjuv ~ lat.x + lon.x+ Breeding_year + month+
                          (1|Observer)+(1|flocksize)+(1|Food_type), data = geese, family = "binomial", na.action = na.omit,
                        REML = F)
#'summary
summary(mod_zone_05)

#'look at anova of this model vs time02
anova(mod_zone02, mod_zone01)
#'not significantly different
library(car)
#'estimate p-vals in this model via an analysis of deviance
Anova(mod_zone_05)
```

## Zone as a coordinate


```{r mod_zone_random}
#'model zone as a random factor, leaving out observer, foodtype and flocksize, since these don't appear to have variance values that justify their inclusion. the maximum likelihood method is used.
mod_zone_random = glmer(propjuv ~ Breeding_year + month +
                          (1|zone), data = geese, family = "binomial",
                        REML = F)

#'summary it
summary(mod_zone_random02)
Anova(mod_zone_random02)

qqnorm(resid(mod_zone_random))
qqline(resid(mod_zone_random))
#'here, breeding year is very significant, while zone doesn't appear to explain any of the variance and cannot be justified as a random factor.

#'plot a histogram of the predicted values and check to see whether it resembles the oberved values. it does not, values are too low.
hist(predict(mod_zone_random02, type = "response"))
hist(geese$propjuv)
```



```{r merge_by_day}
#'slice by time and dmap the minimum
fdistm = lapply(fdistm, function(x){x %>% slice_rows("time") %>% dmap(function(y){min(na.omit(y))})})

#'replace nans
fdistm = lapply(fdistm, function(x){do.call(data.frame,lapply(x, function(y) {replace(y, is.infinite(y), NA)}))})
```

```{r}
a = fdistm[[2]]
a = melt(as.data.frame(a),"time")

ggplot()+
  geom_line(data=a, aes(x=time,y=value, col = variable))
```


```{r famsizes, eval = FALSE}
#'use a for loop on the mean dist object to count rows with distances below 250
for(i in 1:length(f5_mean)){
  f5_mean[[i]]$d1000 = f5_mean[[i]][,c(as.character())] %>%
    apply(1, function(x){
      sum(x < 1000)})
f5_mean[[i]]$d250 = f5_mean[[i]][,grep("X", colnames(f5_mean[[i]]))] %>%
    apply(1, function(x){
      sum(x < 250) })
f5_mean[[i]]$complete = complete.cases(f5_mean[[i]])
}
```

```{r melt_dfs}
#'assign fams
for(i in 1:length(f5_mean)){
  f5_mean[[i]]$fam = names(f5)[i]
}

#'merge list dfs
fsize = rbindlist(f5_mean, fill = T)

#'melt df
fsize = melt(fsize[,c("y","fam","d250","d1000")], id.vars = c("y","fam"))
```

```{r plot}
library(ggplot2)

ggplot()+
  geom_line(data = fsize, aes(x = y, y = as.numeric(value), col = variable))+
  facet_wrap(~fam, scales = "free_x")

```
