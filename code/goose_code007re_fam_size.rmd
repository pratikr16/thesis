---
title: Reconstructing family size from juvenile percentage
bibliography: ~/git/thesis/geese_citations.bib
output: pdf_document
fontsize: 12pt
link-citations: true
citecolor: Emerald
---

From previous data exploration, we know that around 1200 records have family size data, ie, the numbers of families of each size. This leaves the majority of the dataset of some 5800 records without any such information. However, most of the data have a juvenile percentage, or if not, the absolute number of juveniles. Here, I'll try to reconstruct one field -- total number of families -- using the 1200 records available, in an effort to allow me to use the remainder of the records.


```{r, include=FALSE}
#'load knitr
library(knitr)
library(ggplot2)
#'suppress all code output but run code
opts_chunk$set(echo = FALSE)
opts_knit$set(root.dir = "~/git/thesis/")
```

```{r load data, include=FALSE}
geese = read.csv("data.clean.goose.csv", row.names = 1)
fams = read.csv("data.fams.csv", row.names = 1)
```

## Family size counts: How does the total number of families of each size vary with zone and year?

```{r sum_fams_peryear_perzone, include=FALSE}
#'try to get a representation of the number of families of each size recorded per zone per year.
fam_count2 = ddply(fams[,c(1,8:17,21)], c("zone","Breeding_year"), numcolwise(sum, na.rm = T))

library(reshape)

#'then melt
fam_count_melt = melt(fam_count2, id.vars = c("zone","Breeding_year"))
```

The numbers of families of each size is a power law decay. 50% more families with a single juvenile are seen than families with two, and 200% more than families of three, and around 500% more than families of 5. Thereon, larger families are negligibly rare.
There appears to be some relation to the lemming cycle: in lemming-peak years, such as 2002 and 2008, there are fewer families with two or more juveniles. In lemming-peak years, such as 2005, and possibly 2001, the number of families with two juveniles is higher than those with one.

```{r plot_fams_per_year_perzone_persize, fig.cap="The total number of families of each size per zone per year.", fig.height=10, fig.width=10, message=FALSE, warning=FALSE, eval=FALSE}
#'how many families of each size per zone per year
ggplot()+
  geom_col(data = fam_count_melt[fam_count_melt$Breeding_year %in% c(2003,2005,2008,2011) & fam_count_melt$zone %in% c("East Frisia", "IJsselmeer","Rhinelands"),],
                 aes(x = variable,
                     y = value,
                     fill = variable),col=1, lwd = 0.1)+
  scale_fill_brewer()+
  facet_grid(Breeding_year~zone, margins = F, scales = "free_y")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(list(x = "Family size",y = "Count",
            title = "Family size counts per zone per year"))
```

## Family sums: How many families in total are present in flocks in the different zones and in different years?

There doesn't appear to be as great an influence of the lemming cycle on the number of families. Possibly, the lemming-crash reduces the reproductive success of geese and results in smaller families, and also in fewer families.

```{r number_of_fams_years_year, eval=FALSE, fig.cap="Histogram of total number of families of all sizes per flock per year per zone.", fig.height=10, fig.width=10, include=FALSE}
#'a histogram of the number of families per flock per zone per year
ggplot()+
  geom_histogram(data = fams, aes(x=fams), bins = 50)+
  labs(list(title = "Families in flocks per zone per year",
            x = "Number of families",
            y = "Number of flocks"))+
  facet_wrap(~Breeding_year)
```

---

# Number of families ~ number of juveniles

Goose flocks are formed by the aggregation of families [@elder1949role], and this would mean that the number and size of families determines the number and percentage of juveniles in a flock. It should be possible to derive a relationship between the number of juveniles and the number of families in a flock.

```{r log_transform_juvs, eval=FALSE, include=FALSE}
#'split the data by zone and by year
ggplot()+
  geom_point(data = fams, aes(x = log(juvs), y = log(fams)),
             size = 0.5)+
  facet_grid(Breeding_year~zone)

#'split by year alone
ggplot(data = fams[fams$Breeding_year %in% c(2003,2005,2008,2011) &
                     fams$zone %in% c("East Frisia","IJsselmeer","Rhinelands"),])+
  geom_point(aes(x = log(juvs), y = log(fams)),
             size = 0.5)+
  facet_grid(Breeding_year~zone)

#'split with only one log axis
ggplot()+
  geom_point(data = fams, aes(x = (juvs), y = log(fams)),
             size = 0.5)+
  facet_grid(Breeding_year~zone)
```


```{r plot_logfams_v_juvs, fig.cap="Number of families in a flock ~ number of juveniles in the flock. The log transformed sum of families shows a saturating relationship against the number of juveniles. The spread of the data is better constrained by the log-log transformation.", fig.height=7, fig.width=7, warning=FALSE}

#'raw data
fams_juvs_plot2 = ggplot()+
  geom_point(data = fams, aes(x = (juvs), y = log(fams)),
             size = 0.5)+
  labs(list(x = "Juveniles",  y = "ln(Number of families)",
            title = "Number of families ~ number of juveniles, log transformation"))+theme_minimal()

#'log fams vs juvs
fams_juvs_plot1 = ggplot()+
  geom_point(data = fams, aes(x = (juvs), y = (fams)),
             size = 0.5)+
  labs(list(x = "Juveniles",  y = "Number of families",
            title = "Number of families ~ number of juveniles"))+
  xlim(0,300)+ylim(0,200)+theme_minimal()

#'fams vs log juvs
#'not happy with this since it implies that the number of families monotonically increases.

#'log-log transformed data
fams_juvs_plot3 = ggplot()+
  geom_point(data = fams, aes(x = log(juvs), y = log(fams)),
             size = 0.5)+
  labs(list(x = "ln(Juveniles)",  y = "ln(Number of families)",
            title = "Number of families ~ number of juveniles"))+theme_minimal()

#'load grid extra
library(gridExtra)

grid.arrange(fams_juvs_plot1, fams_juvs_plot2, fams_juvs_plot3, ncol = 2)
```

The raw family sum data shows an increasing spread with *x*, and is then log transformed. This data now shows a saturating relationship with the number of juveniles. Log-log transforming the data shows a linear relationship without increasing sread with *x*.

## Predicting total families from juvenile counts, non-linear model

```{r nls_log_data, include=FALSE}

#### log(fams) ~ juvs ####
#create log fam sums object an juvs
logfamsums = log(fams$fams)
juvs = fams$juvs

#'run an nls
fam_juvs_nls1 = nls(logfamsums ~ (a*juvs)/(b+juvs),
                    start = list(a = 6, b = 50))

#'summary
summary(fam_juvs_nls1)

#'check the correlation between predicted and real values
cor(logfamsums[!is.na(juvs)], predict(fam_juvs_nls1))

#get parameter estimate
fam_juvs_nls1$m$getPars()

```

I used the data with log-transformed total families and raw juvenile count to run a simple non-linear regression. Since the log total families shows saturation with increasing juvenile count, I chose to model the relationship between $y = log(total\ families)$ and $x = juvenile\ count$ with a simple Michaelis-Menten function, $y = y_m{\frac{x}{t_{1/2} + x}}$ using the ```nls``` function built into ```R```. Starting parameter estimates were set at $y_m = 6$ and $t_{1/2} = 50$. The model appears to fit the data fairly well, with a correlation of ```r cor(logfamsums[!is.na(juvs)], predict(fam_juvs_nls1))``` between the real and predicted values.

```{r scatterplot_nls_fams_juvs, echo=FALSE, fig.cap="Model fit and data. ", fig.height=7, fig.width=5}
#'fams juvs scatter with fitted function

ggplot(data = fams, aes(x = (juvs), y = log(fams)))+
  geom_point(size = 0.5, pch = 21)+
  labs(list(x = "Juveniles",  y = "ln(Number of families)",
            title = "Number of families ~ number of juveniles, log transformation"))+
  geom_smooth(method = "lm", 
            formula = y ~ exp((4.28*x)/(15.26+x)), 
            lwd = 0.5, col = 2)+
theme_minimal()
```

## Predicting total families from juvenile counts, linear model


```{r lm_loglogfams_juvs, include=FALSE}
#'run an lm on log transformed data
fam_juvs_lm1 = lm(log(fams) ~ log(juvs), data = fams[fams$juvs >0,])

#'summarise it
summary(fam_juvs_lm1)

#coeffs
fam_juvs_lm1$coefficients
```

```{r scatterplot_lm1_fams_juvs, echo=FALSE, fig.cap="Model fit and data. ", fig.height=5, fig.width=5}
#'fams juvs scatter with fitted function

ggplot(data = fams, aes(x = log(juvs), y = log(fams)))+
  geom_point(size = 0.5, pch = 21)+
  labs(list(x = "ln(Juveniles)",  y = "ln(Number of families)",
            title = "Number of families ~ number of juveniles, log-log transformation"))+
  geom_smooth(method = "lm", lwd = 0.5, col = 2)+theme_minimal()
```

I also tried an alternative approach, using log-log transformed data on total families and juvenile counts to run a simple linear model. The model fits the data and appears to explain much of the variation (adjusted R-squared = ```r summary(fam_juvs_lm1)$adj.r.squared```).

## Comparing models

A preliminary comparison of the models appears to show no significant difference. The model using log-log transformed data has a lower AIC score (```r AIC(fam_juvs_lm1)```) than the log-total family model (```r AIC(fam_juvs_nls1)```).

```{r compare_nls_lm_resids, echo=FALSE, fig.height=10, fig.width=10}
#'plot it and the residuals plot of the nls model
par(mfrow = c(2,1))
plot(fam_juvs_lm1,1, main = "Residuals plot, log-log LM", cex = 0.5)
plot(fam_juvs_nls1$m$resid() ~ fam_juvs_nls1$m$fitted(),
     main = "Residuals plot, log-fams NLS", xlab = "Fitted values",
     ylab = "Residuals", ylim = c(-2,2), cex = 0.5)
par(mfrow = c(1,1))
```

```{r compare_lm_nls_qq, echo=FALSE, fig.height=5, fig.width=7, message=FALSE, warning=FALSE}
#try nlstools for a qqplot
library(nlstools)

par(mfrow = c(1,2))
plot(fam_juvs_lm1, 2, main = "Q-Q plot, log-log LM")
plot(nlsResiduals(fam_juvs_nls1), which = 6, 
     main = "Q-Q plot, log-fam NLS", ylim = c(-4,4))
par(mfrow = c(1,1))
```

```{r compare_lm_nls_aic, include=FALSE}
AIC(fam_juvs_lm1); AIC(fam_juvs_nls1)
```

---

# Mean family size ~ number of juveniles

```{r meanfam_v_juveniles, eval=FALSE, include=FALSE}
#'plot meanfam v juveniles
ggplot(data = fams, aes(x = juvs/fams, y = meanfam))+
  geom_point(size = 0.5, pch = 21)+
  labs(list(x = "",y="Mean family size",
            title = "Mean family size ~ number of juveniles"))

```

The mean global family size is ```r mean(fams$meanfam, na.rm = T)```. 
The mean family size is the weighted mean of the number of juveniles in each family weighted by the number of families of that size. Ideally, when all juveniles are counted and belong to a family, the mean family size is the number of juveniles by the number of families. In the field, single or unaffiliated juveniles, and imperfect assignment of juveniles to families, contribute to deviations of the true weighted mean family size from the simple mean.

```{r lm_meanfam_simplemean, include=FALSE}
#'run an lm for meanfam ~ simplemean
simplemean = with(fams, juvs/fams)
meanfam = fams$meanfam

#'lm
meanfam_lm1 = lm(meanfam~simplemean+fams$fams)

#'summary
summary(meanfam_lm1)

#'plot it
plot(meanfam_lm1)
```

A simple linear model to check whether the simple mean could explain the mean family size found that it could not.


---

# References