---
title: Family size and juvenile percentage
bibliography: ~/git/thesis/geese_citations.bib
fontsize: 8pt
link-citations: true
citecolor: Emerald
output: 
  pdf_document: 
    keep_tex: yes
---
```{r, include=TRUE}
#'load knitr
library(knitr)
library(ggplot2)
library(lme4)
library(lubridate)
library(car)
#'suppress all code output but run code
opts_chunk$set(echo = FALSE)
opts_knit$set(root.dir = "~/git/thesis/code")
```

```{r import_data}
#'load geese, fams and fams expanded
geese = read.csv("data.goose.clean.csv", row.names = 1)
fams = read.csv("fams.csv", row.names = 1)
fams.expand = read.csv("fams.expand.csv")

#'convery perc to prop
geese$propjuv = round(geese$propjuv/100, 4)

#'drop zone Other
geese = geese[geese$zone != "Other",]

#'juvenile proportion is actually N_juv/N_sampled
#plot(geese$propjuv2 ~ geese$propjuv,
  #   main = "Calculated vs provided juv prop.",
  #   xlab = "Provided in data",
  #   ylab = "Calculated as N_juvs/No. of whitefronts")

#'change class of time variable to Date
geese$time = as.Date(geese$time)
fams$time = as.Date(fams$time)
fams.expand$time = as.Date(fams.expand$time)

#'add month and day
geese$month = month(geese$time)
geese$day = day(geese$time)
```

# Dataset
The dataset used is the cleaned goose data ```data.goose.clean.csv```. This data has observations between 2001 and 2012, or the breeding years 2011 and 2011. It is restricted to the Netherlands and North Rhine Westphalia, except where it includes areas in East Frisia. Records are classfied into zones. Here, all zones are being used.

# What is the effect of time?

## Predictor: time

### GLMM

```{r glmm_time, eval=FALSE, include=FALSE}
#'model uses time as a Date class object
glmm_time01 = glmer(propjuv ~ time+
                  (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial",
                   na.action = na.omit)

summary(glmm_time02)
#'time is a significant factor, random effects don't explain sufficient variance to justify inclusion.
```

### GLM

```{r glm_time}
glm_time01 = glm(propjuv ~ time,
                  data = geese, family = "binomial",
                   na.action = na.omit)

#'summary
summary(glm_time01)

#'plots
plot(glm_time01)
```


## Predictors: Breeding year * month

### GLMM

```{r glmm_bryr_month01}
glmm_time02 = glmer(propjuv ~ Breeding_year*month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial",
                   na.action = na.omit)

car::Anova(glmm_time02)
#'breeding year and month have significant effects, year*month interaction is not significant, random effects don't explain sufficient variance to be included.
```

### GLM

```{r glm_bryr_month}
#'glm using interaction of year and month
glm_time02a = glm(propjuv ~ Breeding_year*month,
                 data = geese, family = "binomial")

glm_time02b = glm(propjuv ~ Breeding_year*month,
                 data = geese, family = "quasibinomial")

#'summary
summary(glm_time02a); summary(glm_time02b)

#'using a quasibinomial error distribution, breeding year shows a significant effect, but the model doesn't explain any more of the variance than before.
```


## Predictors: Breeding year + month

### GLMM

```{r glmm_bryr_month02}
glmm_time03 = glmer(propjuv ~ Breeding_year+month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial",
                   na.action = na.omit)
summary(glmm_time03)

#'compare model 02 and 03
anova(glmm_time02, glmm_time03)

#'model 03 has a slightly lower AIC score (probably due to one fewer DF), and is not significantly different from model 02. no further attempts are made at modelling month and year as being interacting variables. there is no justification for including random effects since they don't contribute to the variance
```

### GLM

```{r glm_bryr_month}
#'this model ignores random effects and uses month and year as additive effects
glm_time03 = glm(propjuv ~ Breeding_year+month,
                     data = geese, family = "binomial",
                   na.action = na.omit)

#'summary
summary(glm_time03)

#'plot
plot(glm_time03)
```


# What is the effect of zone?

## Predictors: zone * (breeding year + month)

### GLMM

```{r glmm_zone}
glmm_zone01 = glmer(propjuv ~ zone*Breeding_year+ zone* month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial")
summary(glmm_zone01)
#'there don't appear to be any significant differences between zones.

Anova(glmm_zone01)
#'only month and breeding year show significant effects, zone doesn't appear to have an effect. the interaction between zone and year or month does not have an effect. random effects don't explain enough of the variance to justify inclusion
```

### GLM

```{r glm_zone}
#'a glm for the same predictors as above.
glm_zone01 = glm(propjuv ~ zone*Breeding_year+ zone* month,
                   data = geese, family = "binomial")

#'summary
summary(glm_zone01)

#'Anova
car::Anova(glm_zone01)
```


```{r model_lonlat_zone}
#'try with longitude and latitude
sites.coords = read.csv("coords.csv", row.names = 1)

#'merge with geese
geese = merge(geese, sites.coords, by.x = "Site_name", by.y = "places", all.x = T)

#'assign zonal coords if site coords missing
geese$lon.y = ifelse(is.na(geese$lon.y), geese$lon.x, geese$lon.y)
geese$lat.y = ifelse(is.na(geese$lat.y), geese$lat.x, geese$lat.y)

#'run the model with coords lon.x
#mod_lonlat = glmer(propjuv ~ lon.x*lat.x*(Breeding_year+month) +
 #                    (1|Food_type) + (1|Observer) + (1|flocksize),
  #                 data = geese, family = "binomial")

#'a model with lon.x * lat.x * Breeding_year * month fails with errors that the variables are on very different scales. takin the log of the breeding year doesn't resolve the issue.
```


```{r model_lonlat_additive}
#'a very similar model uses the zone coordinates as additive effects along with the breeding year and month
mod_lonlat_add = glmer(propjuv ~ lon.x + lat.x + Breeding_year + month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial")
#'summary
summary(mod_lonlat_add)
#'the summary shows that random effects are not justifiably retained.

glm_lonlat_add = glm(propjuv ~ lon.x + lat.x + Breeding_year + month,
                     data = geese, family = "binomial")

summary(glm_lonlat_add)
plot(glm_lonlat_add)
```

```{r model_latitude}
#'the next model should try using lat.x as a predictor, which might help determine in which direction the gradient if any lies.
mod_zone04 = glmer(propjuv ~ lat.x*log(Breeding_year)+ lat.x*month +
                     (1|Food_type) + (1|Observer) + (1|flocksize),
                   data = geese, family = "binomial")
#'lat.x approaches significance, with a p-value of 0.08, but doesn't appear sufficient to reject the null.
```

```{r model_coords_fixed}
#'the next model uses both zone latitude and longitude as fixed effects.
mod_zone_05 = glmer(propjuv ~ lat.x + lon.x+ Breeding_year + month+
                          (1|Observer)+(1|flocksize)+(1|Food_type), data = geese, family = "binomial", na.action = na.omit,
                        REML = F)
#'summary
summary(mod_zone_05)

#'look at anova of this model vs time02
anova(mod_zone02, mod_zone01)
#'not significantly different
library(car)
#'estimate p-vals in this model via an analysis of deviance
Anova(mod_zone_05)
```

## Zone as a coordinate


```{r mod_zone_random}
#'model zone as a random factor, leaving out observer, foodtype and flocksize, since these don't appear to have variance values that justify their inclusion. the maximum likelihood method is used.
mod_zone_random = glmer(propjuv ~ Breeding_year + month +
                          (1|zone), data = geese, family = "binomial",
                        REML = F)

#'summary it
summary(mod_zone_random02)
Anova(mod_zone_random02)

qqnorm(resid(mod_zone_random))
qqline(resid(mod_zone_random))
#'here, breeding year is very significant, while zone doesn't appear to explain any of the variance and cannot be justified as a random factor.

#'plot a histogram of the predicted values and check to see whether it resembles the oberved values. it does not, values are too low.
hist(predict(mod_zone_random02, type = "response"))
hist(geese$propjuv)
```
