

---
title: Predicting family splits
---

This is an MCMCglmm model to test the hypothesis that family splits are forced, rather than voluntary circumstances. We expect that splits will be associated with a low time to flight, and with a high inter position distance, in keeping with the hypothesis that families split when members lose contact during uncoordinated flights.

Run family visits R script for revisit stats.

```{r load_data}
load("famssplitMCMCmodel.rdata")
load("split.mod.rdata")
```

```{r bind_rows}
splitsmoddata = bind_rows(fams.splits)

#'remove Inf values in times, no idea where they're from
splitsmoddata = splitsmoddata %>% filter(is.finite(t.to.fly),
                                         !is.na(t.to.fly))

#'get time since entry in days, entry calculated from kolguyev birds
splitsmoddata$tdiff = as.numeric(splitsmoddata$time - entry)

#'assign binary response variable
splitsmoddata$split = ifelse(splitsmoddata$event == "Split", 1, 0)

#'assign zeros to NAs
splitsmoddata$split[is.na(splitsmoddata$split)] = 0

splitsmoddata$fam = as.factor(splitsmoddata$fam)

#'get hour of day
splitsmoddata$hour = hour(splitsmoddata$time)
```


```{r max_size}
max = data.frame(fam = names(fams.splits), max = c(5,4,6,5,4,5))

splitsmoddata = merge(splitsmoddata, max, by = "fam", all.x = T)

splitsmoddata$prop = splitsmoddata$fsize/splitsmoddata$max
```


We now run a logistic regression, with
1. time to flight
2. time since entry (proxy for winter days)
3. distance in prev segment
4. hour of day
5. fsize
as fixed predictors, and the family as a mixed effect.

Should max family size be an effect as well? Maybe. Let's see.


```{r run_model}
#'run glmer
library(lme4)

splitsmod = glmer(split ~ t.to.fly + dist + (1|fam), data = splitsmoddata, family = binomial(link = logit))
```

```{r summary_mod}
summary(splitsmod)

library(car)
Anova(splitsmod)
```


```{r model_vis}
library(visreg)

visreg(splitsmod, "t.to.fly", scale = "response")

```


# Predicting splits at the day level

event (split 1, other 0) ~ time in winter + flights (dist over 2km) per day + distance per day + total distance + family size

```{r load_daycoords}
load("fsize_coords.rdata")

#'from fam.move2, get dists, timestamps, etc

#fam.move = fam.move[fam.move$y < 54,]
fam.move2 = split(fam.move)

famcoords$fsize = NULL

#'get famsizes into event data
famcoords = merge(famcoords, daycoords[,c("fam","time","fsize")], by = c("fam","time"))

fam.dist = lapply(fam.move2, function(x){
  dist = c(NA, distance(x))
})

#'add distances
famcoords$dist = unlist(fam.dist)

library(lubridate)
#'get time in winter
source("days_since.r")
famcoords$days = days_since(famcoords$time)
```

```{r prep_data}
#'remove outlier
famcoords = famcoords %>% filter(lat <54)

#'get, per day, the mean and cumulative distances, the number of dists above 2km, mean time since winter, family size

#'distance over 1000m? split or not?
famcoords$flight = famcoords$dist > 1000
famcoords$split = ifelse(!is.na(famcoords$event), famcoords$event == "Split", FALSE)

#'count flights
famstats =  data.frame(famcoords %>% group_by(fam, date = round_date(time, "day")) %>% summarise(mdist = mean(dist, na.rm = T), ddist = sum(na.omit(dist)), days = mean(days, na.rm = T), fsize = min(fsize), flights = sum(flight), split = sum(split)))


#'assign NA flight numbers to 0
famstats$flights[is.na(famstats$flights)] = 0

famstats = data.frame(famstats %>% group_by(fam) %>% mutate(tflights = c(cumsum((flights))), tdist = cumsum(ddist)))

#'make fam factor
famstats$fam = as.factor(famstats$fam)

#'set famstats splits value to 0 or 1. family An lost both juvs on one day. count all splits in the fam.
famstats = famstats %>% group_by(fam) %>% mutate(sumsplit = c(cumsum(split))) 
famstats$split[famstats$split>0] = 1

#famstats = famstats %>% filter(fam %in% c("An","Ev","Ha","Jo","Ma","Na","Ro","Ti","Wo"))
```

```{r run_day_split_mod}
#'day split mod
library(mgcv)
library(lme4)
library(MCMCglmm)
library(gamm4)
famstats = famstats[complete.cases(famstats),]

mod.day.split = 
  glmer(split ~ days + flights + tflights + tdist + ddist + fsize + (1|fam), data = famstats, family = binomial(link = logit))

```

```{r summary_split_mod}
summary(mod.day.split)

save(mod.day.split, entry, file = "split.mod.rdata")

m = predict(mod.day.split, newdata = famstats, type = "response")
```


```{r merge_splitsmod_predicts}
splitsmoddata$p = m

daycoords2 = daycoords %>% filter(lat < 54) %>% group_by(fam, time = round_date(time, "day")) %>% dmap(mean)

famstats = merge(famstats, daycoords2, by.x = c("fam","date"), by.y = c("fam","time"))

famstats$p = m

library(ggplot2)

ggplot()+
  geom_path(data = famstats, aes(x = lon, y = lat, group = fam),
            col = ifelse(famstats$p >0.01, 2, 1))+
  facet_wrap(~fam, scales = "free")

```

```{r}
visdaysplit = visreg(mod.day.split, "days", scale = "response")
visflightssplit = visreg(mod.day.split, "tflights", scale = "response")
vissizesplit = visreg(mod.day.split, "fsize", scale = "response")
visflysplit = visreg(mod.day.split, "flights", scale = "response")

visdaysplitdata = visdaysplit$fit
visflightssplitdata = visflightssplit$fit
vissizesplitdata = vissizesplit$fit
visflysplitdata = visflysplit$fit
visdistsplit = visreg(mod.day.split, "tdist", scale = "response")
visdistsplitdata = visdistsplit$fit
```




```{r plot_day_split_probs}
a = theme(panel.grid.minor = element_blank())
b = theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())
#png(file = "~/git/thesis/texts/split_time.png", height = 800, width = 800, res = 300, title = "split_time")
split1 = ggplot()+
  geom_line(data = visdaysplitdata, aes(x = days, y = visregFit), col = 1)+
  ylim(0,1)+
  labs(list(x = "Days since arrival", y= "p(split)", title = "a"), size = 2)+
  theme_bw()+a+theme(plot.title = element_text(size = 20))+
  theme(axis.title = element_text(size = 20))

dev.off()
```

```{r plot_flights_split}
png(file = "~/git/thesis/texts/split_tflights.png", height = 800, width = 800, res = 300, title = "split_totalflights")
split2 = ggplot()+
  geom_line(data = visflightssplitdata, aes(x = tflights, y = visregFit), col = 1)+
  ylim(0,1)+
  labs(list(x = "Total flights", y= NULL, title = "d"))+
  theme_bw()+a+theme(plot.title = element_text(size = 20))+
  theme(axis.title = element_text(size = 20))
dev.off()
```

```{r plot_size_split}
png(file = "~/git/thesis/texts/split_size.png", height = 800, width = 800, res = 300, title = "split_size")
split3 = ggplot()+
  geom_line(data = vissizesplitdata, aes(x = fsize, y = visregFit), col = 1)+
  ylim(0,1)+
  labs(list(x = "N juveniles", y= "p(split)", title = "c"))+
  theme_bw()+a+theme(plot.title = element_text(size = 20))+
  theme(axis.title = element_text(size = 20))
dev.off()
```

```{r plot_flights_split}
png(file = "~/git/thesis/texts/split_dist.png", height = 800, width = 800, res = 300, title = "split_tdist")
split4 = ggplot()+
  geom_line(data = visdistsplitdata, aes(x = tdist/100, y = visregFit), col = 1)+
  ylim(0,1)+
  labs(list(x = "100 kms. cumulatively flown", y= NULL, title = "b"))+
  theme_bw()+a+theme(plot.title = element_text(size = 20))+
  theme(axis.title = element_text(size = 20))
dev.off()
```

```{r}
library(gridExtra)
pdf(file = "~/git/thesis/texts/split_dayprob.pdf", height = 6, width = 8, title = "split_dayprob")
grid.arrange(split1, split4, split3, split2, ncol = 2)

dev.off()
```



