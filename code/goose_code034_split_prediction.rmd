---
title: Predicting family splits
editor_options: 
  chunk_output_type: console
---

This is an MCMCglmm model to test the hypothesis that family splits are forced, rather than voluntary circumstances. We expect that splits will be associated with a low time to flight, and with a high inter position distance, in keeping with the hypothesis that families split when members lose contact during uncoordinated flights.

Run family visits R script for revisit stats.

```{r load_data}
#load("famssplitMCMCmodel.rdata")
load("split.mod.rdata")
```

```{r bind_rows}
splitsmoddata = bind_rows(fams.splits)

#'remove Inf values in times, no idea where they're from
splitsmoddata = splitsmoddata %>% filter(is.finite(t.to.fly),
                                         !is.na(t.to.fly))

#'get time since entry in days, entry calculated from kolguyev birds
splitsmoddata$tdiff = as.numeric(splitsmoddata$time - entry)

#'assign binary response variable
splitsmoddata$split = ifelse(splitsmoddata$event == "Split", 1, 0)

#'assign zeros to NAs
splitsmoddata$split[is.na(splitsmoddata$split)] = 0

splitsmoddata$fam = as.factor(splitsmoddata$fam)

#'get hour of day
splitsmoddata$hour = hour(splitsmoddata$time)
```


```{r max_size}
max = data.frame(fam = names(fams.splits), max = c(5,4,6,5,4,5))

splitsmoddata = merge(splitsmoddata, max, by = "fam", all.x = T)

splitsmoddata$prop = splitsmoddata$fsize/splitsmoddata$max
```


We now run a logistic regression, with
1. time to flight
2. time since entry (proxy for winter days)
3. distance in prev segment
4. hour of day
5. fsize
as fixed predictors, and the family as a mixed effect.

Should max family size be an effect as well? Maybe. Let's see.


```{r run_model}
#'run glmer
library(lme4)

splitsmod = glmer(split ~ t.to.fly + dist + (1|fam), data = splitsmoddata, family = binomial(link = logit))
```

```{r summary_mod}
summary(splitsmod)

library(car)
Anova(splitsmod)
```


```{r model_vis}
library(visreg)

visreg(splitsmod, "t.to.fly", scale = "response")

```


# Predicting splits at the day level

event (split 1, other 0) ~ time in winter + flights (dist over 2km) per day + distance per day + total distance + family size

```{r load_daycoords}
load("fsize_coords.rdata")

#'bind rows daycoords
daycoords = bind_rows(daycoords)
```

```{r}
library(move)
#'get speed, dist, lag, angle.
fam.move2 = lapply(fam.move, function(x){x = data.frame(speed = c(NA, speed(x)), dist = c(NA, distance(x)), angle = c(NA, angle(x)), lag = c(NA, timeLag(x)), lon = coordinates(x)[,1], lat = coordinates(x)[,2], time = timestamps(x))})

for(i in 1:13){
  fam.move2[[i]]$fam = names(fam.move2)[i]
}

#'now rbind
fam.move2 = bind_rows(fam.move2)

#'add splits
fam.move2 = merge(fam.move2,splits %>% dplyr::select(time, fam, event), by = c("time", "fam"), all.x = T)

fam.move2 = merge(fam.move2, daycoords[,c("fam","time","fsize")], by = c("fam","time"))

fam.move2 =  fam.move2 %>% arrange(fam, time)

fam.move2$event = ifelse(is.na(fam.move2$event), "other", fam.move2$event)

fam.move2$event = as.factor(fam.move2$event)
```


```{r}
#'get famsizes into event data
#fam.move2 = merge(fam.move2, daycoords[,c("fam","time","fsize")], by = c("fam","time"))

library(lubridate)
#'get time in winter
source("days_since.r")
fam.move2$days = days_since(fam.move2$time)
```

```{r prep_data}
#'remove outlier
#'get, per day, the mean and cumulative distances, the number of dists above 1km, mean time since winter, family size

#'distance over 1000m? split or not?
fam.move2$flight = fam.move2$dist > 1000
fam.move2$split = ifelse(fam.move2$event == "split", T, FALSE)

#'count flights
famstats =  data.frame(fam.move2 %>% group_by(fam, date = round_date(time, "day")) %>% summarise(mdist = mean(dist, na.rm = T), ddist = sum(na.omit(dist)), days = mean(days, na.rm = T), fsize = min(fsize), flights = sum(flight), split = sum(split), mlon = mean(lon, na.rm = T), mlat = mean(lat, na.rm = T)))


#'assign NA flight numbers to 0
famstats$flights[is.na(famstats$flights)] = 0

famstats = data.frame(famstats %>% group_by(fam) %>% mutate(tflights = c(cumsum((flights))), tdist = cumsum(ddist)))

#'make fam factor
famstats$fam = as.factor(famstats$fam)

#'set famstats splits value to 0 or 1. family An lost both juvs on one day. count all splits in the fam.
famstats = famstats %>% group_by(fam) %>% mutate(sumsplit = c(cumsum(split))) 
famstats$split[famstats$split>0] = 1

#famstats = famstats %>% filter(fam %in% c("An","Ev","Ha","Jo","Ma","Na","Ro","Ti","Wo"))
```

```{r run_day_split_mod}
#'day split mod
library(mgcv)
library(lme4)
##library(MCMCglmm)
library(gamm4)
famstats = famstats[complete.cases(famstats),]

mod.day.split = 
  glmer(split ~ sqrt(days) + fsize + flights + log(ddist) + (1|fam), data = famstats, family = binomial(link = logit))

#modsplit2 = 
 # bam(split ~ ti(flights)+ ti(log(ddist))+ ti(flights, log(ddist)) + ti(sqrt(days)) + ti(fsize) + ti(sqrt(days), fsize) + s(fam, bs = "re"), data = famstats, family = "binomial")

#famstats$predict = predict(mod.day.split, newdata = famstats, type = "response", allow.new.levels = T)
```

```{r summary_split_mod}
summary(mod.day.split)

summary(modsplit2)

#'plot family size and days

save(mod.day.split, modsplit2, entry, file = "split.mod.rdata")

load("split.mod.rdata")

m = predict(mod.day.split, newdata = famstats, type = "response", re.form =~(1|fam))
```



```{r merge_splitsmod_predicts}
splitsmoddata$p = m

daycoords2 = daycoords %>% filter(lat < 54) %>% group_by(fam, time = round_date(time, "day")) %>% dmap(mean)

famstats = merge(famstats, daycoords2, by.x = c("fam","date"), by.y = c("fam","time"))

famstats$fsize = famstats$fsize.x

famstats$p = predict(mod.day.split, newdata = famstats, type = "response", re.form =~(1|fam))

library(ggplot2)
a = theme(panel.grid = element_blank(), legend.position="none")

ggplot()+
  geom_path(data = famstats, aes(x = mlon, y = mlat, group = fam),
            col = ifelse(famstats$p >0.01, 2, 1))+
  facet_wrap(~fam, scales = "free")

```

## Fig 6a. p ~ size

```{r plot_day_split_probs}
#pdf(file = "~/git/thesis/texts/fig6a.pdf", height = 4, width = 4)
#'
f6a = 
  ggplot()+
  #geom_vline(data = famstats %>% filter(split == 1), aes(xintercept=days), col = 2, lty = 3)+
  geom_smooth(data = famstats, aes(x = fsize, y = p), col = 1, lwd = 0.4, method = "loess")+
  labs(list(x = "Family size", y= "Split probability", title = "(a)"))+
  theme_bw()+g1+ylim(NA,0.09)

#dev.off()
```

## Fig 6b. p ~ daily sum distance

```{r plot_flights_split}
#pdf(file = "~/git/thesis/texts/fig6d.pdf", height = 4, width = 4)
#'
f6b = 
  ggplot()+
   # geom_vline(data = famstats %>% filter(split == 1), aes(xintercept=ddist/1e3), col = 2, lty = 1, lwd = 0.2)+
  #geom_line(data = visdistsplitdata, aes(x = ddist, y = visregFit), col = 1, lwd = 0.4)+
  geom_smooth(data = famstats, aes(x = ddist/1e3, y = p), col = 1, lwd = 0.4)+
  labs(list(x = "Daily distance (km)", y= NULL, title = "(b)"))+
  theme_bw()+g1+xlim(NA,100)#+ylim(NA, 0.1)

dev.off()
```

## Fig 6c. p ~ size

```{r plot_size_split}
#pdf(file = "~/git/thesis/texts/fig6c.pdf", height = 4, width = 4)
#'

#f6c = 
ggplot()+
    geom_vline(data = famstats %>% filter(split == 1), aes(xintercept=fsize), col = 2, lty = 3)+
  geom_line(data = vissizesplitdata, aes(x = fsize, y = visregFit), col = 1, lwd = 1)+
  labs(list(x = "Family size", y= NULL, title = "C"))+
  theme_bw()+g1+ylim(NA,1)

dev.off()
```

```{r plot_flights_split}
#pdf(file = "~/git/thesis/texts/fig6b.pdf", height = 4, width = 4)
#'
#f6b = 
  ggplot()+
  geom_vline(data = famstats %>% filter(split == 1), aes(xintercept=mdist/1e3), col = 2, lty = 3)+
  geom_line(data = visdistsplitdata, aes(x = mdist/1e3, y = visregFit), col = 1)+
  labs(list(x = "Total distance travelled (km)", y= NULL, title ="B"))+
  theme_bw()+g1

dev.off()
```

# Export png

```{r}
png(filename = "~/git/family_sizes_geese_2018/texts/fig6.png", res = 300, height = 1600, width = 1600)

gridExtra::grid.arrange(f6a, f6b, ncol = 2)

dev.off()
```