---
title: bams for Hypothesis 1 - 3, SOVON data
---

# Load environment

```{r set_env, message=FALSE}
#'load knitr
library(knitr);library(plyr);library(dplyr);library(data.table);library(purrr);library(ggplot2)

#'load model libs
library(gam);library(mgcv);library(gamm4);library(visreg)

#'suppress all code output but run code
opts_chunk$set(eval = FALSE)
```

# Source data

```{r load_data}
#'load data.goose.clean
source("dataprep.R")

#'remove any flocksizes mistakenly assigned 0
fams.expand = fams.expand %>% filter(flocksize > 0)

#'make level of predation a factor. currently being modelled as the numeric value p.index
fams.expand$pred = as.factor(fams.expand$pred)

#'should only complete cases be considered? yes, for the predictors.
fams.expand = fams.expand[complete.cases(fams.expand[,c("lon","lat","flocksize","famsize","Breeding_year","p.index","days","t_to_out","t_since_in")]),]
```

```{r bryear_to_factor}
#'set the breeding year to be a factor
fams.expand$Breeding_year = as.factor(as.character(fams.expand$Breeding_year))

geeseorg$breedyr = as.factor(geeseorg$breedyr)
```

# Reduce the Rhinelands data

```{r}
#'how many families from the Rhinelands?
plyr::count(fams.expand, "zone")
#'as many as from the other zones combined, almost

#'subsample to have only half as many. first remove rhinelands data from the frame
fams.expand.sub = fams.expand %>% filter(zone !=  "Rhinelands")
#'now subsample
fams.rhine = fams.expand %>% filter(zone == "Rhinelands")
n.rhine = dim(fams.rhine)[1]
fams.rhine = fams.rhine[runif(n.rhine/2, 1, n.rhine),]

#'reattach to the main data
fams.expand.sub = rbind(fams.expand.sub, fams.rhine)
```


# List hypotheses 01, 02 and 03

1. Families with more juveniles are found in the west, and, 
2. Families with more juveniles are found in smaller flocks, and,
3. Family size decreases over the winter.

Data used: Family size data (51,000 families, 45,000 complete cases).

# Which time proxy?

```{r}
mtime = glmer(famsize ~ t_to_out + t_since_in+ (1|Breeding_year) + (1|Observer) + (1|Food_type), data = fams.expand.sub[runif(10000, 1, dim(fams.expand.sub)[1]),], family = "poisson", na.action = na.omit)

mtime2 = update(mtime, .~. -t_since_in)
mtime3 = update(mtime, .~. -t_to_out)
library(MuMIn)

timesel = model.sel(mtime2, mtime3)
```



## Model 03
Remove time to departure.

```{r m03}
#'remove NAs

fams.expand.sub = fams.expand.sub %>% filter(complete.cases(lon, flocksize, t_since_in, p.index, Breeding_year, Observer, Food_type))

#'remove t_to_out
mod03 = bam(famsize ~ lon + flocksize + t_since_in + p.index + s(Breeding_year, bs = "re") + s(Observer, bs = "re") + s(Food_type, bs = "re"), data = fams.expand.sub, family = "poisson", na.action = na.omit)
```


# geese.org data
Run model three on geese.org data. Random effects now include "id", and do not include observer and habitat type. Fixed effects do not include flock size.

```{r gorg.m03}
mod03.gorg = bam(famsize ~ lon + t_since_in + p.index + s(neckring, bs = "re") + s(breedyr, bs = "re"), data = geeseorg, family = poisson)
```

```{r}
summary(mod03.gorg)
o2.mixed.mods(mod03.gorg)
```

# geese.org successful fams

```{r gorg.success}
mod03.gorg.s = bam(famsize ~ lon + t_since_in + p.index + s(neckring, bs = "re") + s(breedyr, bs = "re"), data = geeseorg %>% filter(famsize > 0), family = poisson)
```

```{r}
summary(mod03.gorg.s)
```

---

