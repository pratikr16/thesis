---
title: bams for Hypothesis 1 - 3, SOVON data
---

# Load environment

```{r set_env, message=FALSE}
#'load knitr
library(knitr);library(plyr);library(dplyr);library(data.table);library(purrr);library(ggplot2)

#'load model libs
library(gam);library(mgcv);library(gamm4);library(visreg)

#'suppress all code output but run code
opts_chunk$set(eval = FALSE)
```

# Source data

```{r load_data}
#'load data.goose.clean
source("dataprep.R")

#'remove any flocksizes mistakenly assigned 0
fams.expand = fams.expand %>% filter(flocksize > 0)

```

# Reduce the Rhinelands data

```{r}
#'how many families from the Rhinelands?
plyr::count(fams.expand, "zone")

#fams.expand = fams.expand %>% filter(complete.cases(lon, flocksize, t_since_in, p.index, Breeding_year, Observer, Food_type))
#'as many as from the other zones combined, almost

#'subsample to have only half as many. first remove rhinelands data from the frame
fams.expand.sub = fams.expand %>% filter(zone !=  "Rhinelands")
#'now subsample
fams.rhine = fams.expand %>% filter(zone == "Rhinelands")
n.rhine = dim(fams.rhine)[1]
fams.rhine = fams.rhine[runif(n.rhine/2, 1, n.rhine),]

#'reattach to the main data
fams.expand.sub = rbind(fams.expand.sub, fams.rhine)
```


# List hypotheses 01, 02 and 03

1. Families with more juveniles are found in the west, and, 
2. Families with more juveniles are found in smaller flocks, and,
3. Family size decreases over the winter.

Data used: Family size data (51,000 families, 45,000 complete cases).

# Which time proxy?

```{r, eval=FALSE}
mtime = glmer(famsize ~ t_to_out + t_since_in + (1|Breeding_year) + (1|Observer) + (1|Food_type), data = fams.expand.sub[runif(10000, 1, dim(fams.expand.sub)[1]),], family = "poisson", na.action = na.omit)

mtime2 = update(mtime, .~. -t_since_in)
mtime3 = update(mtime, .~. -t_to_out)
library(MuMIn)

timesel = model.sel(mtime2, mtime3)
```

# Family size
```{r m03}
#'remove NAs

#fams.expand.sub = fams.expand.sub %>% filter(complete.cases(lon, flocksize, t_since_in, p.index, Breeding_year, Observer, Food_type))

#'remove t_to_out
mod03 = glmer(famsize ~ flocksize + t_since_in + p.index + (1|Breeding_year) + (1|Observer) + (1|Food_type), data = fams.expand.sub, family = "poisson")
```

# Distance from breeding grounds ~ family size

```{r}

fams.expand.sub$distkol = round(fams.expand.sub$distkol)

geeseorg$distkol = round(geeseorg$distkol)

distmod = glmer((distkol) ~ (famsize) + t_since_in + (1|Breeding_year) + (1|Food_type) + (1|Observer), data = fams.expand.sub %>% filter(t_since_in < 60), family = "poisson")

distmod_late = glmer((distkol) ~ (famsize) + t_since_in + (1|Breeding_year) + (1|Food_type) + (1|Observer), data = fams.expand.sub %>% filter(t_since_in > 60), family = "poisson")

distmod2 = glmer(distkol ~ (famsize) + t_since_in + (1|breedyr) + (1|neckring), data = geeseorg %>% filter(t_since_in < 60), family = "gaussian")

distmod2_late = glmer(distkol ~ (famsize) + t_since_in + (1|breedyr) + (1|neckring), data = geeseorg %>% filter(t_since_in > 60), family = "gaussian")
```

```{r}


save(distmod, distmod_late, distmod2, distmod2_late, file = "distmods.Rdata")
```



# geese.org data
Run model three on geese.org data. Random effects now include "id", and do not include observer and habitat type. Fixed effects do not include flock size.

```{r gorg.m03}
mod03.gorg = glmer(famsize ~ t_since_in + p.index + (1|neckring) + + (1|breedyr/neckring), data = geeseorg, family = poisson)
```

```{r}
summary(mod03.gorg)
o2.mixed.mods(mod03.gorg)
```

# geese.org successful fams

```{r gorg.success}
mod03.gorg.s = glmer(famsize ~ t_since_in + p.index + (1|neckring) + + (1|breedyr/neckring), data = geeseorg %>% filter(famsize > 0), family = poisson)
```

```{r}
summary(mod03.gorg.s)
```

---

