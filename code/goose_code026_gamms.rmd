---
title: bams for Hypothesis 1 - 3, SOVON data
---

# Load environment

```{r set_env, message=FALSE}
#'load knitr
library(knitr);library(plyr);library(dplyr);library(data.table);library(purrr);library(ggplot2)

#'load model libs
library(gam);library(mgcv);library(gamm4);library(itsadug)

#'suppress all code output but run code
opts_chunk$set(eval = FALSE)
```

# Source data

```{r load_data}
#'load data.goose.clean
source("dataprep.R")

#'remove any flocksizes mistakenly assigned 0
fams.expand = fams.expand %>% filter(flocksize > 0)

#'make level of predation a factor. currently being modelled as the numeric value p.index
fams.expand$pred = as.factor(fams.expand$pred)

#'should only complete cases be considered? yes, for the predictors.
fams.expand = fams.expand[complete.cases(fams.expand[,c("lon","lat","flocksize","famsize","Breeding_year","p.index","days","t_to_out","t_since_in","durwinter")]),]
```

```{r bryear_to_factor}
#'set the breeding year to be a factor
fams.expand$Breeding_year = as.factor(as.character(fams.expand$Breeding_year))

geeseorg$breedyr = as.factor(geeseorg$breedyr)
```

# Reduce the Rhinelands data

```{r}
#'how many families from the Rhinelands?
plyr::count(fams.expand, "zone")
#'as many as from the other zones combined, almost

#'subsample to have only half as many. first remove rhinelands data from the frame
fams.expand.sub = fams.expand %>% filter(zone !=  "Rhinelands")
#'now subsample
fams.rhine = fams.expand %>% filter(zone == "Rhinelands")
n.rhine = dim(fams.rhine)[1]
fams.rhine = fams.rhine[runif(n.rhine/2, 1, n.rhine),]

#'reattach to the main data
fams.expand.sub = rbind(fams.expand.sub, fams.rhine)
```


# List hypotheses 01, 02 and 03

1. Families with more juveniles are found in the west, and, 
2. Families with more juveniles are found in smaller flocks, and,
3. Family size decreases over the winter.

Data used: Family size data (51,000 families, 45,000 complete cases).

# SOVON data

## Model 01
Includes only the three main hypothesised predictors.

```{r m01}
#'run a bamm with the smoothing applied only to the coordinates
library(mgcv)

#mod01 = bam(famsize ~ (lon) + flocksize + days, data = fams.expand, family = "poisson")
```

```{r summary01}
summary(mod01)
AIC(mod01)
vis.gam(mod01, type = "response",
        view = c("flocksize","days"), theta = -235, color = "terrain")
```

## Model 03
Remove time to departure.

```{r m03}
#'remove t_to_out
mod03 = bam(famsize ~ lon + flocksize + t_since_in  + p.index + s(Food_type, bs = "re") + s(Observer, bs = "re") + s(Breeding_year, bs = "re") + s(Site_name, bs = "re"), data = fams.expand.sub, family = "poisson", na.action = na.omit)

mod03pred = predict(mod03, newdata = fams.expand.sub, by = "terms", type = "response")
```


```{r vis.bam03}
#pdf(file = "gam03days_lon.pdf")
vis.gam(mod03, view = c("lon", "t_since_in"), color = rev("terrain"), plot.type = "contour", type = "response", main = NULL, xlab = "Long", ylab = "Days since first arrivals")
#dev.off()

summary(mod03)
```

# geese.org data
Run model three on geese.org data. Random effects now include "id", and do not include observer and habitat type. Fixed effects do not include flock size.

## Remove remaining outliers

```{r gorg_clean_again}
geeseorg = geeseorg %>% filter(round(lon) %in% 0:10, round(lat) %in% 50:56)
```


```{r gorg.m03}
mod03.gorg = bam(famsize ~ lon + t_since_in + p.index + s(id, bs = "re") + s(breedyr, bs = "re"), data = geeseorg, family = poisson)
```

```{r}
summary(mod03.gorg)
o2.mixed.mods(mod03.gorg)
```


```{r}
vis.gam(mod03.gorg, view = c("lon", "t_since_in"), type = "response", plot.type = "contour", color = "terrain", main = NULL, xlab = "Long",ylab = "Days since first arrivals")
```

---

# GLMERs

```{r}
glmer03 = glmer(famsize ~ lon + flocksize + t_since_in + lon:t_since_in + p.index + (1|Food_type) + (1|Observer) + (1|Breeding_year), data = fams.expand.sub, family = "poisson")

glmer04 = glmer(famsize ~ t_since_in + (1|Food_type) + (1|Observer) + (1|Breeding_year), data = fams.expand.sub, family = "poisson")
```

```{r}
summary(glmer03)

o2.mixed.mods(glmer03)

anova(glmer03, glmer04)
```


# Time gam

```{r}
timegam = gam(lon ~ time + s(Breeding_year, bs = "re") + s(Observer, bs = "re") + s(Food_type, bs = "re"), data = fams.expand, family = gaussian)
```


