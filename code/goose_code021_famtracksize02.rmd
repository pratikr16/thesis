---
title: "Processing family tracks 01"
---
  
```{r load_env, message=FALSE, warning=FALSE}
source("knitr_options.r")
#'suppress all code output but run code
opts_chunk$set(eval = FALSE)
opts_knit$set(root.dir = "~/git/thesis/code")
```

```{r load_famtracks}
load("~/git/thesis/code/fams2016.nobursts.rdata")
load("~/git/thesis/code/oldfams.nobursts.rdata")
```

```{r separate_2015}
#'get 2015 fams, Ha, He, Jo, and Na
fams2015 = fams2014.5[c("Ha", "He", "Jo", "Na")]
#'remove from fams2014
fams2014 = fams2014.5[c("An","Ma","Ro")]

```

```{r export}
save(fams2015, file = "fams2015.rdata")
save(fams2014, file = "fams2014.rdata")
```


```{r join_lists}
#'modify lists to have the adult in position
#'fam An
fams2014[["An"]] = rev(fams2014[["An"]])
#'fam Ro
fams2014[["Ro"]] = fams2014[["Ro"]][c(2,3,1,4)]

#'family Ha
fams2015[["Ha"]] = fams2015[["Ha"]][c(3,1,2,4,5)]

#'family Jo
fams2015[["Jo"]] = rev(fams2015[["Jo"]])

#'family Na
fams2015[["Na"]] = rev(fams2015[["Na"]])
```

```{r append_lists}
f1 = append(fams2014, c(fams2015, fams2016.4))
```


```{r round_time}
#'round time to the nearest minute
f1 = lapply(f1, function(x){lapply(x, function(y){y %>% mutate(t = round_date(t, "minute"))})})

#'remove v, fam, and lag
f1 = lapply(f1, function(x){lapply(x, function(y){y %>% select(t, lon, lat)})})
```

```{r distances}
library(purrr)
#'a left join here
f2 = lapply(f1, function(x){reduce(x, left_join, by = "t")})
```

```{r get_distances}
library(geosphere)

#'get distances in another list

fdists = vector("list", 13)

for(z in 1:length(f2)){
 for(i in 1:dim(f2[[z]])[1]){
  for(j in seq(1, length(f2[[z]])-2 ,2))
   fdists[[z]] = c(fdists[[z]], distVincentyEllipsoid(p1 = f2[[z]][i,c(2,3)], p2 = f2[[z]][i,c(j+1,j+2)]))
}
}
```

```{r dist_matrix}
#'make a duplicate
fdistm = fdists

#'make each numeric column a matrix. this will need a for loop
for(i in 1:length(f2)){
  fdistm[[i]] = matrix(fdistm[[i]], ncol = length(f1[[i]]), byrow = T)
}
```

```{r convert_to_df}
#'make dists a df
fdistm = lapply(fdistm, function(x){x = as.data.frame(x)})

#'add names to dfs
names(fdistm) = names(f2)
```

```{r add_time}
#'add the timestamps to the matrix
for(i in 1:length(f2)){
  fdistm[[i]] = cbind(fdistm[[i]], time = (f2[[i]]$t))
}
```

```{r}
save(fdistm, f2, file = "famdists02.rdata")
```

